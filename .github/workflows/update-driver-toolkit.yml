name: Update Driver Toolkit

on:
  schedule:
    - cron: '0 2 * * *'  # Nightly at 2 AM UTC
  workflow_dispatch:

jobs:
  update-driver-toolkit:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y jq curl
        
    - name: Install OpenShift CLI
      run: |
        # Create temporary directory for extraction
        temp_dir=$(mktemp -d)
        cd "$temp_dir"
        curl -LO https://mirror.openshift.com/pub/openshift-v4/clients/ocp/stable/openshift-client-linux.tar.gz
        tar -xzf openshift-client-linux.tar.gz
        sudo mv oc /usr/local/bin/
        sudo chmod +x /usr/local/bin/oc
        # Clean up temporary directory
        cd "$GITHUB_WORKSPACE"
        if [ -n "$temp_dir" ] && [ -d "$temp_dir" ]; then
          rm -rf "$temp_dir"
        fi
        

    - name: Generate driver toolkit JSON
      env:
        CI: true
        OUTPUT_FILE: driver-toolkit.json.new
      run: |
        cd driver-toolkit
        ./driver-toolkit.sh
        
    - name: Check for changes
      id: check_changes
      run: |
        cd driver-toolkit
        if ! cmp -s driver-toolkit.json driver-toolkit.json.new; then
          echo "changes=true" >> $GITHUB_OUTPUT
          mv driver-toolkit.json.new driver-toolkit.json
        else
          echo "changes=false" >> $GITHUB_OUTPUT
          rm driver-toolkit.json.new
        fi
        
    - name: Create or Update Pull Request
      if: steps.check_changes.outputs.changes == 'true'
      uses: peter-evans/create-pull-request@v7
      with:
        branch-token: ${{ secrets.GITHUB_TOKEN }}
        commit-message: 'feat: update driver-toolkit.json with latest OpenShift Driver Toolkit releases'
        title: 'feat: update driver-toolkit.json with latest OpenShift Driver Toolkit releases'
        body: |
          This PR updates the [driver-toolkit.json](driver-toolkit/driver-toolkit.json) file with the latest OpenShift Driver Toolkit release information.
          
          **Auto-updated nightly** - Generated by [update-driver-toolkit.yml](.github/workflows/update-driver-toolkit.yml).
          
          This PR will be automatically updated if new releases are detected before it's merged.
        branch: update-driver-toolkit
        delete-branch: true