# Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.
# SPDX-License-Identifier: Apache-2.0

name: Update Driver Toolkit

on:
  schedule:
    - cron: '0 2 * * *'  # Nightly at 2 AM UTC
  workflow_dispatch:

jobs:
  update-driver-toolkit:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y jq curl

    - name: Install OpenShift CLI
      run: |
        # Create temporary directory for extraction
        temp_dir=$(mktemp -d)
        cd "$temp_dir"
        curl -LO https://mirror.openshift.com/pub/openshift-v4/clients/ocp/stable/openshift-client-linux.tar.gz
        tar -xzf openshift-client-linux.tar.gz
        sudo mv oc /usr/local/bin/
        sudo chmod +x /usr/local/bin/oc
        # Clean up temporary directory
        cd "$GITHUB_WORKSPACE"
        if [ -n "$temp_dir" ] && [ -d "$temp_dir" ]; then
          rm -rf "$temp_dir"
        fi

    - name: Generate driver toolkit JSON
      env:
        CI: true
        OUTPUT_FILE: driver-toolkit.json.new
      run: |
        cd driver-toolkit
        ./driver-toolkit.sh

    - name: Check for existing PR and content differences
      id: check_pr_and_changes
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        cd driver-toolkit

        # Check if PR exists
        pr_exists=$(gh pr list --head update-driver-toolkit --json number --jq 'length > 0')

        if [ "$pr_exists" = "true" ]; then
          # Fetch the driver-toolkit.json from the PR branch
          gh api repos/${{ github.repository }}/contents/driver-toolkit/driver-toolkit.json?ref=update-driver-toolkit \
            --jq '.content' | base64 -d > driver-toolkit.json.pr

          # Compare new content with PR content
          if cmp -s driver-toolkit.json.pr driver-toolkit.json.new; then
            echo "should_update=false" >> $GITHUB_OUTPUT
            rm driver-toolkit.json.new driver-toolkit.json.pr
          else
            echo "should_update=true" >> $GITHUB_OUTPUT
            mv driver-toolkit.json.new driver-toolkit.json
            rm driver-toolkit.json.pr
          fi
        else
          # No existing PR, check if content differs from main
          if ! cmp -s driver-toolkit.json driver-toolkit.json.new; then
            echo "should_update=true" >> $GITHUB_OUTPUT
            mv driver-toolkit.json.new driver-toolkit.json
          else
            echo "should_update=false" >> $GITHUB_OUTPUT
            rm driver-toolkit.json.new
          fi
        fi

    # Third-party tool: peter-evans/create-pull-request
    # Used to automate pull request creation for driver toolkit updates
    - name: Create or Update Pull Request
      if: steps.check_pr_and_changes.outputs.should_update == 'true'
      uses: peter-evans/create-pull-request@v7
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        commit-message: 'feat: update driver-toolkit.json with latest dtk releases'
        title: 'feat: update driver-toolkit.json with latest OpenShift Driver Toolkit releases'
        body: |
          This PR updates the [driver-toolkit.json](https://github.com/awslabs/kmod-with-kmm-for-ai-chips-on-aws/blob/main/driver-toolkit/driver-toolkit.json) file with the latest OpenShift Driver Toolkit release information.

          **Auto-updated nightly** - Generated by [update-driver-toolkit.yml](https://github.com/awslabs/kmod-with-kmm-for-ai-chips-on-aws/blob/main/.github/workflows/update-driver-toolkit.yml).

          This PR will be automatically updated if new releases are detected before it's merged.
        branch: update-driver-toolkit
        delete-branch: true
